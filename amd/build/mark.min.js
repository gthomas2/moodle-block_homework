define(["jquery","block_homework/filterable_exportable_table","block_homework/bootstrap-switch","block_homework/form_validate","block_homework/util"],function(a,b,c,d,e){"use strict";var f=function(){var c,f=[],g=[],h=[],i=function(e){c=M.str.block_homework,f=e.achievement,g=e.behaviour,0!==a("#ond_form").length&&(a("#btncancel").on("click",j),a("#btnsubmit").click(function(){d.validateInputs(k,n)}),a(".ond_subgroupcontroller").change(function(){var b=a(this),c=a("#"+b.attr("id")+"_subgroup_on"),d=a("#"+b.attr("id")+"_subgroup_off");b.prop("checked")||0===b[0].selectedIndex?(c.fadeIn(),d.fadeOut()):(c.fadeOut(),d.fadeIn())}).change(),a.fn.bootstrapSwitch&&a("input[type=checkbox][data-toggle=toggle]").bootstrapSwitch({handleWidth:40,labelWidth:1,onText:c.on,offText:c.off}),a("#achievementtype").on("change",l),l(),a("#behaviourtype").on("change",m),m(),a(".quickgrade").on("change",function(){var b=a(this),c=b.closest("tr");c.children().css("background-color","#e6ffe6");var d=b.prop("name").split("_"),e=d[1];a("#modified_"+e).val(1)}),b.initialise("ond_assign_marking",[0,"asc"],M.cfg.wwwroot+"/blocks/homework",{paging:!1,scrollY:!1}))};this.start=function(a){var b=function(){return"undefined"!=typeof M&&"undefined"!=typeof M.str&&"undefined"!=typeof M.str.block_homework};e.whenTrue(b,function(){i(a)},!0,20)};var j=function(){window.location=M.cfg.wwwroot+"/blocks/homework/view.php?course="+a("#course").val()+"&mark=1"},k=function(a){var b="";return b},l=function(){var b=a("#achievementpoints");b.length&&b.val(f[a("#achievementtype").val()])},m=function(){var b=a("#behaviourpoints");b.length&&b.val(g[a("#behaviourtype").val()])},n=function(){for(var e=a("#bulkachievement").prop("checked"),f=a("#bulkbehaviour").prop("checked"),g=b.getInputData(),i=a("#learners").val().split(","),j=[],k=0;k<i.length;k++){if(1==g.filter("#modified_"+i[k]).val()){var l=g.filter("[name=quickgrade_"+i[k]+"]").val();if(""!==l){var m={action:"mark",sesskey:a("#sesskey").val(),cmid:a("#id").val(),learnerid:i[k],name:g.filter("#name_"+i[k]).val(),grade:l,feedback:g.filter("#feedback_"+i[k]).val()};j.push(m)}}if(e&&1!=g.filter("#unsubmitted_"+i[k]).val()){var n={action:"achievement",sesskey:a("#sesskey").val(),cmid:a("#id").val(),learnerid:i[k],name:g.filter("#name_"+i[k]).val(),achievementtype:a("#achievementtype").val(),achievementactivity:a("#achievementactivity").val(),achievementcomments:a("#achievementcomments").val(),achievementpoints:a("#achievementpoints").val(),achievementreporter:a("#achievementreporter").val()};j.push(n)}if(f&&1==g.filter("#unsubmitted_"+i[k]).val()){var s={action:"behaviour",sesskey:a("#sesskey").val(),cmid:a("#id").val(),learnerid:i[k],name:g.filter("#name_"+i[k]).val(),behaviourtype:a("#behaviourtype").val(),behaviouractivity:a("#behaviouractivity").val(),behaviourstatus:a("#behaviourstatus").val(),behaviouraction:a("#behaviouraction").val(),behaviourcomments:a("#behaviourcomments").val(),behaviourpoints:a("#behaviourpoints").val(),behaviourreporter:a("#behaviourreporter").val()};j.push(s)}}if(0===j.length)d.showDialog(c.nothingdone,c.nothingdonefull,c.ok);else{var t=0;p(j,10,function(b,d){"mark"===b.action?(q(t/j.length*100,c.gradingassignmentfor+" "+b.name),a.post("ajax/mark_assignment.php",b).done(function(a,b,d){if(!a.success){var e=c.failedtosetmarkfor+" "+a.name+"; "+a.error;h.push(e)}}).fail(function(b,d,e){var f=r(a(this)[0].data),g=c.failedtosetmarkfor+f.name+"; "+e;h.push(g)}).always(function(){t+=.5,q(t/j.length*100,c.savinggrades),t>=j.length&&o(h)})):"achievement"===b.action?(q(t/j.length*100,c.addingachievementfor+" "+b.name),a.post("ajax/write_behaviour.php",b).done(function(a,b,d){if(!a.success){var e=c.failedtoaddachievementfor+" "+a.name+"; "+a.error;h.push(e)}}).fail(function(b,d,e){var f=r(a(this)[0].data),g=c.failedtoaddachievementfor+" "+f.name+"; "+e;h.push(g)}).always(function(){t+=.5,q(t/j.length*100,c.savingachievement),t>=j.length&&o(h)})):"behaviour"===b.action&&(q(t/j.length*100,c.addingbehaviourfor+" "+b.name),a.post("ajax/write_behaviour.php",b).done(function(a,b,d){if(!a.success){var e=c.failedtoaddbehaviourfor+" "+a.name+"; "+a.error;h.push(e)}}).fail(function(b,d,e){var f=r(a(this)[0].data),g=c.failedtoaddbehaviourfor+" "+f.name+"; "+e;h.push(g)}).always(function(){t+=.5,q(t/j.length*100,c.savingbehaviour),t>=j.length&&o(h)})),t+=.5,q(t/j.length*100),t>=j.length&&o(h)})}},o=function(b){var d=c.alldone,e="";b.length>0?(e='<div class="ond_centered"><button id="ond_btn_retry" type="button" class="ond_material_button_raised">'+c.tryagain+'</button><button id="ond_btn_cancel" type="button" class="ond_material_button_raised">'+c.cancel+"</button></div>",d+=", "+b.length+" error(s)",a("#ond_form_progress").after('<div id="ond_errors"><pre>'+b.join("<br>")+"</pre></div>").after(e),a("#ond_btn_retry").on("click",function(){location.reload()}),a("#ond_btn_cancel").on("click",j)):(e='<div class="ond_centered"><button id="ond_btn_ok" type="button" class="ond_material_button_raised">'+c.ok+"</button></div>",a("#ond_form_progress").after(e),a("#ond_btn_ok").on("click",j)),q(100,d)},p=function(a,b,c){var d=null,e=0,f=function(){e!==a.length&&(c.call(d,a[e],e),e++,setTimeout(f,b))};f()},q=function(b,d){d=d||c.saving,b=Math.round(b);var e=a("#ond_form_progress");"none"===e.css("display")&&(a("#ond_form").css("display","none"),e.css("display","block"));var f=b*e.width()/100,g=d+'<div id="ond_form_progress_bar_number">'+b+"%</div>";a("#ond_form_progress_bar").css("width",f).animate(100).html(g)},r=function(a){for(var b=a.split("&"),c={},d=0;d<b.length;d++){var e=b[d].split("=");c[e[0]]=decodeURIComponent(e[1].replace(/\+/g,"%20")||"")}return JSON.parse(JSON.stringify(c))}};return new f});